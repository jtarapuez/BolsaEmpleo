<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">
<h:head>
    <f:facet name="first">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    </f:facet>
    <title>Registro de Postulante - Bolsa de Empleo (Stepper)</title>
    <link rel="icon" type="image/png" href="#{request.contextPath}/serenity-layout/images/favicon.ico" />
    <!-- CSS externo comentado para evitar conflictos - usando estilos inline -->
    <!-- <h:outputStylesheet name="css/stepper.css" /> -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .logo-header {
            max-width: 1200px;
            margin: 0 auto 10px auto;
            text-align: left;
            padding: 0 20px;
        }
        .logo-header img {
            max-width: 250px;
            height: auto;
            display: inline-block;
        }
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 30px;
            text-align: center;
        }
        
        /* ============================================
           STEPPER INDEPENDIENTE - SIN CONFLICTOS CON PRIMEFACES
           ============================================ */
        
        /* Ocultar completamente el navbar de PrimeFaces */
        .custom-wizard-stepper .ui-wizard-navbar,
        .custom-wizard-stepper .ui-wizard-step-titles {
            display: none !important;
        }
        
        /* Contenedor del stepper personalizado */
        .custom-stepper-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: relative;
            margin: 40px 0 80px 0;
            padding: 0;
            width: 100%;
        }
        
        /* Línea de fondo gris */
        .custom-stepper-container::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 0;
            right: 0;
            height: 4px;
            background-color: #e0e0e0;
            z-index: 1;
        }
        
        /* Línea de progreso azul */
        .custom-stepper-progress {
            position: absolute;
            top: 25px;
            left: 0;
            height: 4px;
            background-color: #54c2e9;
            transition: width 0.5s ease;
            z-index: 2;
            width: 0%;
        }
        
        /* Cada paso del stepper */
        .custom-stepper-step {
            position: relative;
            z-index: 3;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            cursor: pointer;
        }
        
        /* Círculo del paso */
        .custom-stepper-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #54c2e9; /* Azul claro por defecto */
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: normal;
            color: #ffffff;
            transition: all 0.3s ease;
            position: relative;
            margin: 0 auto;
        }
        
        /* Paso activo - Azul oscuro */
        .custom-stepper-step.active .custom-stepper-circle {
            background-color: #3081c7;
        }
        
        /* Paso completado - Verde */
        .custom-stepper-step.completed .custom-stepper-circle {
            background-color: #4caf50;
        }
        
        /* Checkmark para paso completado */
        .custom-stepper-step.completed .custom-stepper-circle::after {
            content: '✓';
            font-size: 24px;
            color: #ffffff;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* Ocultar número cuando está completado */
        .custom-stepper-step.completed .custom-stepper-number {
            display: none;
        }
        
        /* Texto debajo del círculo */
        .custom-stepper-label {
            margin-top: 10px;
            font-size: 11px;
            color: #000000;
            text-align: center;
            line-height: 1.3;
            font-weight: normal;
            width: 140px;
            word-wrap: break-word;
        }
        
        .stepper-content {
            margin-top: 30px;
            min-height: 400px;
        }
        
        .stepper-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .stepper-button {
            padding: 10px 30px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stepper-button-back {
            background-color: #f5f5f5;
            color: #424242;
        }
        
        .stepper-button-back:hover {
            background-color: #e0e0e0;
        }
        
        .stepper-button-next {
            background-color: #1976d2;
            color: #ffffff;
        }
        
        .stepper-button-next:hover {
            background-color: #1565c0;
        }
    </style>
</h:head>
<h:body>
    <!-- Logo en la cabecera - Arriba del contenido blanco -->
    <div class="logo-header">
        <h:graphicImage library="images" name="LogoOfertaTrabajo.png" 
                      alt="Logo Bolsa de Empleo" />
    </div>
    
    <div class="container">
        <h1 class="page-title">Registro de Postulante - Bolsa de Empleo</h1>
        
        <h:form id="formRegistroPostulanteStepper">
            <p:messages closable="true" />
            
            <!-- STEPPER PERSONALIZADO INDEPENDIENTE -->
            <div class="custom-stepper-container" id="customStepper">
                <div class="custom-stepper-progress" id="stepperProgress"></div>
                
                <div class="custom-stepper-step active" data-step="1" onclick="goToStep(1)">
                    <div class="custom-stepper-circle">
                        <span class="custom-stepper-number">1</span>
                    </div>
                    <div class="custom-stepper-label">Información Básica</div>
                </div>
                
                <div class="custom-stepper-step" data-step="2" onclick="goToStep(2)">
                    <div class="custom-stepper-circle">
                        <span class="custom-stepper-number">2</span>
                    </div>
                    <div class="custom-stepper-label">Formación Académica</div>
                </div>
                
                <div class="custom-stepper-step" data-step="3" onclick="goToStep(3)">
                    <div class="custom-stepper-circle">
                        <span class="custom-stepper-number">3</span>
                    </div>
                    <div class="custom-stepper-label">Experiencia Laboral</div>
                </div>
                
                <div class="custom-stepper-step" data-step="4" onclick="goToStep(4)">
                    <div class="custom-stepper-circle">
                        <span class="custom-stepper-number">4</span>
                    </div>
                    <div class="custom-stepper-label">Cursos y Conocimientos</div>
                </div>
            </div>
            
            <!-- Contenido del Wizard - SIN NAVBAR -->
            <div class="stepper-content">
                <p:wizard showNavBar="false"
                          styleClass="custom-wizard-stepper"
                          widgetVar="stepperWizard"
                          flowListener="#{registroPostulanteBean.onFlowProcess}">
                
                    <!-- PASO 1: Información Básica -->
                    <p:tab id="infoBasica" title="Información Básica">
                        <div class="ui-g ui-fluid" style="margin-top: 20px;">
                            <div class="ui-g-12">
                                <h3>Paso 1: Información Básica</h3>
                                <p>En este paso se registrarán los datos personales del postulante.</p>
                                <p><strong>Tabla:</strong> boe_aspirante_tbl</p>
                                <p>Los campos de este paso incluyen:</p>
                                <ul>
                                    <li>Número de cédula</li>
                                    <li>Fecha de emisión</li>
                                    <li>Nombres y apellidos</li>
                                    <li>Correo electrónico</li>
                                    <li>Teléfono</li>
                                    <li>Dirección</li>
                                    <li>Otros datos personales</li>
                                </ul>
                            </div>
                        </div>
                    </p:tab>
                    
                    <!-- PASO 2: Formación Académica -->
                    <p:tab id="formacionAcademica" title="Formación Académica">
                        <div class="ui-g ui-fluid" style="margin-top: 20px;">
                            <div class="ui-g-12">
                                <h3>Paso 2: Formación Académica</h3>
                                <p>En este paso se registrará la formación académica del postulante.</p>
                                <p><strong>Tabla:</strong> boe_informacion_academica_tbl</p>
                                <p>Los campos de este paso incluyen:</p>
                                <ul>
                                    <li>Nivel educativo</li>
                                    <li>Institución</li>
                                    <li>Título obtenido</li>
                                    <li>Área de estudio</li>
                                    <li>Fechas de inicio y fin</li>
                                    <li>Estado del estudio</li>
                                </ul>
                            </div>
                        </div>
                    </p:tab>
                    
                    <!-- PASO 3: Experiencia Laboral -->
                    <p:tab id="experienciaLaboral" title="Experiencia Laboral">
                        <div class="ui-g ui-fluid" style="margin-top: 20px;">
                            <div class="ui-g-12">
                                <h3>Paso 3: Experiencia Laboral</h3>
                                <p>En este paso se registrará la experiencia laboral del postulante.</p>
                                <p><strong>Tabla:</strong> boe_antecedentes_laborales_tbl</p>
                                <p>Los campos de este paso incluyen:</p>
                                <ul>
                                    <li>Nombre de la empresa</li>
                                    <li>Cargo desempeñado</li>
                                    <li>Área de trabajo</li>
                                    <li>Funciones realizadas</li>
                                    <li>Fechas de inicio y fin</li>
                                    <li>Referencias laborales</li>
                                </ul>
                            </div>
                        </div>
                    </p:tab>
                    
                    <!-- PASO 4: Cursos y Conocimientos -->
                    <p:tab id="cursosConocimientos" title="Cursos y Conocimientos">
                        <div class="ui-g ui-fluid" style="margin-top: 20px;">
                            <div class="ui-g-12">
                                <h3>Paso 4: Cursos y Conocimientos</h3>
                                <p>En este paso se registrarán los cursos y conocimientos adicionales del postulante.</p>
                                <p><strong>Tabla:</strong> boe_conocimientos_adicionales_tbl</p>
                                <p>Los campos de este paso incluyen:</p>
                                <ul>
                                    <li>Nombre del curso</li>
                                    <li>Institución</li>
                                    <li>Tipo de curso</li>
                                    <li>Área de estudio</li>
                                    <li>Horas de duración</li>
                                    <li>Certificado obtenido</li>
                                </ul>
                            </div>
                        </div>
                    </p:tab>
                    
                </p:wizard>
            </div>
            
            <!-- Botones de navegación personalizados -->
            <div class="stepper-buttons">
                <p:commandButton value="Anterior" 
                                 onclick="previousStep(); return false;"
                                 styleClass="stepper-button stepper-button-back" />
                
                <p:commandButton id="btnSiguiente" value="Siguiente" 
                                 onclick="nextStep(); return false;"
                                 styleClass="stepper-button stepper-button-next" />
            </div>
        </h:form>
    </div>
    
    <!-- JavaScript para sincronizar stepper independiente con wizard -->
    <h:outputScript>
        var currentStep = #{registroPostulanteBean.pasoActual};
        var totalSteps = 4;
        
        // Mapeo de pasos a IDs de tabs
        var stepToTab = {
            1: 'infoBasica',
            2: 'formacionAcademica',
            3: 'experienciaLaboral',
            4: 'cursosConocimientos'
        };
        
        // Mapeo inverso: tab ID a número de paso
        var tabToStep = {
            'infoBasica': 1,
            'formacionAcademica': 2,
            'experienciaLaboral': 3,
            'cursosConocimientos': 4
        };
        
        // Función mejorada para detectar paso actual
        function detectCurrentStep() {
            var wizard = PF('stepperWizard');
            
            // Método 1: Usar getStep() del wizard (más confiable)
            if (wizard) {
                try {
                    var currentTab = wizard.getStep();
                    if (currentTab) {
                        var step = tabToStep[currentTab];
                        if (step) {
                            return step;
                        }
                    }
                } catch (e) {
                    // Ignorar errores
                }
            }
            
            // Método 2: Buscar el tab activo en el DOM por ID
            var formId = 'formRegistroPostulanteStepper';
            for (var tabId in tabToStep) {
                var fullTabId = formId + ':' + tabId;
                var tabElement = document.getElementById(fullTabId);
                if (tabElement) {
                    var style = window.getComputedStyle(tabElement);
                    if (style.display !== 'none' &amp;&amp; style.visibility !== 'hidden') {
                        return tabToStep[tabId];
                    }
                }
            }
            
            // Método 3: Buscar por clase y visibilidad
            var tabs = document.querySelectorAll('.custom-wizard-stepper .ui-wizard-content .ui-tabview-panel');
            for (var i = 0; i &lt; tabs.length; i++) {
                var tab = tabs[i];
                var style = window.getComputedStyle(tab);
                if (style.display !== 'none' &amp;&amp; style.visibility !== 'hidden') {
                    // Intentar extraer el ID del tab
                    var tabId = tab.id;
                    if (tabId) {
                        var parts = tabId.split(':');
                        var cleanTabId = parts[parts.length - 1];
                        var step = tabToStep[cleanTabId];
                        if (step) return step;
                    }
                    // Si no podemos extraer el ID, usar el índice
                    return i + 1;
                }
            }
            
            return currentStep || 1;
        }
        
        // Ir a un paso específico
        function goToStep(step) {
            if (step &lt; 1 || step &gt; totalSteps) return;
            
            var wizard = PF('stepperWizard');
            if (!wizard) {
                // Si el wizard aún no está listo, esperar un poco
                setTimeout(function() { goToStep(step); }, 100);
                return;
            }
            
            // Navegar al tab correspondiente
            var tabId = stepToTab[step];
            if (tabId) {
                wizard.loadStep(tabId);
                updateStepper(step);
            }
        }
        
        // Siguiente paso - MEJORADO
        function nextStep() {
            var wizard = PF('stepperWizard');
            if (!wizard) return;
            
            // Guardar el paso actual antes de cambiar
            var oldStep = currentStep;
            
            // Si estamos en el último paso (4) y se hace clic en "Finalizar"
            if (oldStep === totalSteps) {
                // Marcar el paso 4 como completado (verde)
                markStepAsCompleted(totalSteps);
                return;
            }
            
            // Llamar al método next del wizard
            wizard.next();
            
            // Actualizar stepper inmediatamente (optimista)
            var newStep = Math.min(oldStep + 1, totalSteps);
            updateStepper(newStep);
            
            // Sincronizar después de que el wizard actualice (confirmación)
            setTimeout(function() {
                var detectedStep = detectCurrentStep();
                updateStepper(detectedStep);
            }, 100);
            
            setTimeout(function() {
                var detectedStep = detectCurrentStep();
                updateStepper(detectedStep);
            }, 300);
            
            setTimeout(function() {
                var detectedStep = detectCurrentStep();
                updateStepper(detectedStep);
            }, 600);
        }
        
        // Marcar un paso como completado (verde)
        function markStepAsCompleted(step) {
            if (step &lt; 1 || step &gt; totalSteps) return;
            
            var steps = document.querySelectorAll('.custom-stepper-step');
            var progress = document.getElementById('stepperProgress');
            
            // Marcar todos los pasos hasta el indicado como completados
            steps.forEach(function(stepElement, index) {
                var stepNum = index + 1;
                stepElement.classList.remove('active', 'completed');
                
                if (stepNum &lt;= step) {
                    stepElement.classList.add('completed');
                }
            });
            
            // Actualizar línea de progreso al 100%
            if (progress) {
                progress.style.width = '100%';
            }
            
            // Actualizar currentStep
            currentStep = step;
        }
        
        // Paso anterior - MEJORADO
        function previousStep() {
            var wizard = PF('stepperWizard');
            if (!wizard) return;
            
            // Guardar el paso actual antes de cambiar
            var oldStep = currentStep;
            
            // Llamar al método back del wizard
            wizard.back();
            
            // Actualizar stepper inmediatamente (optimista)
            var newStep = Math.max(oldStep - 1, 1);
            updateStepper(newStep);
            
            // Sincronizar después de que el wizard actualice (confirmación)
            setTimeout(function() {
                var detectedStep = detectCurrentStep();
                updateStepper(detectedStep);
            }, 100);
            
            setTimeout(function() {
                var detectedStep = detectCurrentStep();
                updateStepper(detectedStep);
            }, 300);
            
            setTimeout(function() {
                var detectedStep = detectCurrentStep();
                updateStepper(detectedStep);
            }, 600);
        }
        
        // Sincronizar stepper con el estado actual del wizard
        function syncStepperWithWizard() {
            var detectedStep = detectCurrentStep();
            if (detectedStep !== currentStep) {
                updateStepper(detectedStep);
            }
        }
        
        // Actualizar visualización del stepper
        function updateStepper(activeStep) {
            if (!activeStep || activeStep &lt; 1 || activeStep &gt; totalSteps) {
                activeStep = 1;
            }
            
            // Validar que activeStep esté en rango válido (1-4)
            if (activeStep &lt; 1) activeStep = 1;
            if (activeStep &gt; totalSteps) activeStep = totalSteps;
            
            currentStep = activeStep;
            
            var steps = document.querySelectorAll('.custom-stepper-step');
            var progress = document.getElementById('stepperProgress');
            
            if (!steps || steps.length === 0) {
                return;
            }
            
            // Actualizar clases de los pasos
            steps.forEach(function(step, index) {
                var stepNum = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNum &lt; activeStep) {
                    step.classList.add('completed');
                } else if (stepNum === activeStep) {
                    step.classList.add('active');
                }
            });
            
            // Actualizar línea de progreso
            if (progress) {
                // Si es el paso 4, la línea debe llegar al 100%
                var percentage = activeStep === 1 ? 0 : ((activeStep - 1) / (totalSteps - 1)) * 100;
                // Asegurar que el paso 4 muestre 100%
                if (activeStep === totalSteps) {
                    percentage = 100;
                }
                progress.style.width = percentage + '%';
            }
            
            // Actualizar texto del botón "Siguiente"
            updateNextButtonText(activeStep);
        }
        
        // Actualizar texto del botón "Siguiente" a "Finalizar" en el último paso
        function updateNextButtonText(step) {
            var btnSiguiente = document.getElementById('formRegistroPostulanteStepper:btnSiguiente');
            if (!btnSiguiente) {
                // Intentar buscar por clase si no se encuentra por ID
                var buttons = document.querySelectorAll('.stepper-button-next');
                if (buttons.length &gt; 0) {
                    btnSiguiente = buttons[0];
                }
            }
            
            if (btnSiguiente) {
                if (step === totalSteps) {
                    // Último paso: cambiar a "Finalizar"
                    btnSiguiente.value = 'Finalizar';
                    if (btnSiguiente.textContent !== undefined) {
                        btnSiguiente.textContent = 'Finalizar';
                    }
                    // También actualizar el span interno si existe
                    var span = btnSiguiente.querySelector('span');
                    if (span) {
                        span.textContent = 'Finalizar';
                    }
                } else {
                    // No es el último paso: mantener "Siguiente"
                    btnSiguiente.value = 'Siguiente';
                    if (btnSiguiente.textContent !== undefined) {
                        btnSiguiente.textContent = 'Siguiente';
                    }
                    // También actualizar el span interno si existe
                    var span = btnSiguiente.querySelector('span');
                    if (span) {
                        span.textContent = 'Siguiente';
                    }
                }
            }
        }
        
        // Interceptar eventos del wizard de PrimeFaces
        function setupWizardListeners() {
            var wizard = PF('stepperWizard');
            if (!wizard) {
                setTimeout(setupWizardListeners, 200);
                return;
            }
            
            // Interceptar next() y back() del wizard
            if (wizard.next) {
                var originalNext = wizard.next.bind(wizard);
                wizard.next = function() {
                    originalNext();
                    // Sincronizar después de múltiples delays
                    setTimeout(syncStepperWithWizard, 50);
                    setTimeout(syncStepperWithWizard, 200);
                    setTimeout(syncStepperWithWizard, 500);
                };
            }
            
            if (wizard.back) {
                var originalBack = wizard.back.bind(wizard);
                wizard.back = function() {
                    originalBack();
                    // Sincronizar después de múltiples delays
                    setTimeout(syncStepperWithWizard, 50);
                    setTimeout(syncStepperWithWizard, 200);
                    setTimeout(syncStepperWithWizard, 500);
                };
            }
        }
        
        // Inicializar cuando el DOM esté listo
        jQuery(document).ready(function() {
            // Inicializar con el paso del bean
            updateStepper(currentStep);
            
            // Configurar listeners del wizard
            setupWizardListeners();
            
            // Sincronizar después de que PrimeFaces cargue todo
            setTimeout(function() {
                syncStepperWithWizard();
            }, 500);
            
            setTimeout(function() {
                syncStepperWithWizard();
            }, 1000);
            
            // Sincronización periódica más frecuente
            setInterval(function() {
                syncStepperWithWizard();
            }, 300);
        });
        
        // Sincronizar después de actualizaciones AJAX de PrimeFaces
        if (window.PrimeFaces &amp;&amp; window.PrimeFaces.ajax) {
            if (typeof PrimeFaces.ajax.addOnUpdateCallback === 'function') {
                PrimeFaces.ajax.addOnUpdateCallback(function() {
                    setTimeout(syncStepperWithWizard, 300);
                });
            }
        }
        
        // MutationObserver mejorado para detectar cambios en el DOM
        if (window.MutationObserver) {
            var observer = new MutationObserver(function(mutations) {
                var shouldSync = false;
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' &amp;&amp; mutation.attributeName === 'style') {
                        var target = mutation.target;
                        if (target.classList.contains('ui-tabview-panel')) {
                            shouldSync = true;
                        }
                    }
                    if (mutation.type === 'childList') {
                        var target = mutation.target;
                        if (target.classList.contains('ui-wizard-content')) {
                            shouldSync = true;
                        }
                    }
                });
                
                if (shouldSync) {
                    setTimeout(syncStepperWithWizard, 100);
                }
            });
            
            jQuery(document).ready(function() {
                setTimeout(function() {
                    var wizardContent = document.querySelector('.custom-wizard-stepper .ui-wizard-content');
                    if (wizardContent) {
                        observer.observe(wizardContent, {
                            attributes: true,
                            attributeFilter: ['style', 'class'],
                            childList: true,
                            subtree: true
                        });
                    }
                }, 1000);
            });
        }
        
        // Función global para que el flowListener pueda llamarla
        window.updateStepperFromBean = function(step) {
            if (step &gt;= 1 &amp;&amp; step &lt;= totalSteps) {
                updateStepper(step);
            }
        };
    </h:outputScript>
</h:body>
</html>


